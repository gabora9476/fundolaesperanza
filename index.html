<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Consejo Comunal Fundo La Esperanza</title>

<!-- Favicon Configuration -->
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<meta name="theme-color" content="#ffffff">

<style>
* {
margin: 0;
padding: 0;
box-sizing: border-box;
}

body {
font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
background: linear-gradient(135deg, #e91e63 0%, #f06292 100%);
min-height: 100vh;
color: #333;
font-size: 14px;
}

.container {
max-width: 1200px;
margin: 0 auto;
padding: 20px;
}

.header {
text-align: center;
margin-bottom: 40px;
animation: fadeInDown 0.8s ease-out;
}

.logo {
background: rgba(255, 255, 255, 0.1);
backdrop-filter: blur(20px);
border-radius: 20px;
padding: 30px;
margin-bottom: 20px;
border: 1px solid rgba(255, 255, 255, 0.2);
}

.logo h1 {
color: white;
font-size: 28px;
font-weight: 700;
margin-bottom: 10px;
}

.logo p {
color: rgba(255, 255, 255, 0.8);
font-size: 16px;
}

.nav-buttons {
display: flex;
gap: 15px;
justify-content: center;
flex-wrap: wrap;
margin-bottom: 30px;
animation: fadeInUp 0.8s ease-out;
}

.nav-btn {
padding: 12px 24px;
background: rgba(255, 255, 255, 0.15);
backdrop-filter: blur(10px);
border: 1px solid rgba(255, 255, 255, 0.2);
border-radius: 12px;
color: white;
cursor: pointer;
transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
font-size: 14px;
font-weight: 500;
}

.nav-btn:hover, .nav-btn.active {
background: rgba(255, 255, 255, 0.25);
transform: translateY(-2px);
box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
}

.content-section {
display: none;
animation: fadeIn 0.5s ease-out;
}

.content-section.active {
display: block;
}

.card {
background: rgba(255, 255, 255, 0.95);
backdrop-filter: blur(20px);
border-radius: 20px;
padding: 30px;
margin-bottom: 20px;
border: 1px solid rgba(255, 255, 255, 0.3);
box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
transition: transform 0.3s ease;
}

.card:hover {
transform: translateY(-5px);
}

.form-group {
margin-bottom: 20px;
}

.form-group label {
display: block;
margin-bottom: 8px;
font-weight: 600;
color: #444;
font-size: 13px;
}

.form-control {
width: 100%;
padding: 12px 16px;
border: 2px solid rgba(233, 30, 99, 0.1);
border-radius: 10px;
background: rgba(255, 255, 255, 0.8);
transition: all 0.3s ease;
font-size: 14px;
}

.form-control:focus {
outline: none;
border-color: #e91e63;
background: white;
box-shadow: 0 0 0 3px rgba(233, 30, 99, 0.1);
}

.btn-primary {
background: linear-gradient(135deg, #e91e63, #f06292);
color: white;
border: none;
padding: 14px 28px;
border-radius: 10px;
cursor: pointer;
font-weight: 600;
font-size: 14px;
transition: all 0.3s ease;
box-shadow: 0 4px 15px rgba(233, 30, 99, 0.3);
}

.btn-primary:hover {
transform: translateY(-2px);
box-shadow: 0 8px 25px rgba(233, 30, 99, 0.4);
}

.btn-secondary {
background: rgba(255, 255, 255, 0.2);
color: #e91e63;
border: 2px solid #e91e63;
padding: 12px 24px;
border-radius: 10px;
cursor: pointer;
font-weight: 600;
font-size: 14px;
transition: all 0.3s ease;
margin-right: 10px;
}

.btn-secondary:hover {
background: #e91e63;
color: white;
transform: translateY(-2px);
}

.btn-danger {
background: linear-gradient(135deg, #ff6b6b, #ee5a5a);
color: white;
border: none;
padding: 10px 20px;
border-radius: 8px;
cursor: pointer;
font-size: 12px;
transition: all 0.3s ease;
}

.btn-danger:hover {
transform: translateY(-1px);
box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
}

.grid {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
gap: 20px;
margin-bottom: 30px;
}

.event-card {
background: rgba(255, 255, 255, 0.9);
border-radius: 15px;
padding: 20px;
border-left: 4px solid #e91e63;
transition: all 0.3s ease;
}

.event-card:hover {
transform: translateX(5px);
box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
}

.event-date {
background: linear-gradient(135deg, #e91e63, #f06292);
color: white;
padding: 8px 12px;
border-radius: 8px;
font-size: 12px;
font-weight: 600;
display: inline-block;
margin-bottom: 10px;
}

.residents-table {
width: 100%;
border-collapse: collapse;
margin-top: 20px;
background: white;
border-radius: 10px;
overflow: hidden;
box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
}

.residents-table th,
.residents-table td {
padding: 12px;
text-align: left;
border-bottom: 1px solid rgba(0, 0, 0, 0.1);
font-size: 13px;
}

.residents-table th {
background: #e91e63;
color: white;
font-weight: 600;
}

.residents-table tr:hover {
background: rgba(233, 30, 99, 0.05);
}

.modal {
display: none;
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
background: rgba(0, 0, 0, 0.5);
backdrop-filter: blur(5px);
z-index: 1000;
}

.modal.active {
display: flex;
align-items: center;
justify-content: center;
animation: fadeIn 0.3s ease-out;
}

.modal-content {
background: white;
border-radius: 20px;
padding: 30px;
max-width: 500px;
width: 90%;
max-height: 80vh;
overflow-y: auto;
animation: slideIn 0.3s ease-out;
}

.certificate {
background: white;
padding: 40px;
border-radius: 15px;
box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
font-family: 'Times New Roman', serif;
line-height: 1.6;
color: #333;
}

.certificate-header {
text-align: center;
margin-bottom: 30px;
border-bottom: 2px solid #e91e63;
padding-bottom: 20px;
}

.certificate h2 {
color: #e91e63;
font-size: 18px;
margin-bottom: 10px;
}

.certificate h3 {
color: #333;
font-size: 16px;
text-decoration: underline;
margin: 20px 0;
}

.membrete-imagen {
width: 100%;
max-width: 500px;
height: auto;
margin-bottom: 20px;
}

.floating-elements {
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
pointer-events: none;
z-index: -1;
}

.floating-circle {
position: absolute;
background: rgba(255, 255, 255, 0.1);
border-radius: 50%;
animation: float 6s ease-in-out infinite;
}

.floating-circle:nth-child(1) {
width: 80px;
height: 80px;
top: 10%;
left: 10%;
animation-delay: 0s;
}

.floating-circle:nth-child(2) {
width: 120px;
height: 120px;
top: 70%;
right: 10%;
animation-delay: 2s;
}

.floating-circle:nth-child(3) {
width: 60px;
height: 60px;
top: 30%;
right: 20%;
animation-delay: 4s;
}

.success-message {
background: linear-gradient(135deg, #4CAF50, #45a049);
color: white;
padding: 15px;
border-radius: 10px;
margin: 20px 0;
text-align: center;
font-weight: 600;
animation: slideIn 0.5s ease-out;
}

.error-message {
background: linear-gradient(135deg, #f44336, #e53935);
color: white;
padding: 15px;
border-radius: 10px;
margin: 20px 0;
text-align: center;
font-weight: 600;
animation: slideIn 0.5s ease-out;
}

.censo-card {
position: relative;
background: linear-gradient(135deg, #e91e63, #f06292);
color: white;
cursor: pointer;
transition: all 0.3s ease;
border-radius: 15px;
padding: 20px;
overflow: hidden;
}

.censo-card:hover {
transform: translateY(-5px);
box-shadow: 0 15px 35px rgba(233, 30, 99, 0.3);
}

.censo-card h3 {
margin-bottom: 15px;
font-size: 18px;
}

.censo-card p {
margin-bottom: 10px;
opacity: 0.9;
font-size: 14px;
}

.censo-info-badge {
background: rgba(255,255,255,0.2);
padding: 8px 12px;
border-radius: 8px;
font-size: 12px;
font-weight: 600;
display: inline-block;
margin-top: 10px;
}

.censo-card-actions {
position: absolute;
top: 15px;
right: 15px;
display: flex;
gap: 5px;
}

.btn-icon {
width: 32px;
height: 32px;
border-radius: 6px;
border: none;
display: flex;
align-items: center;
justify-content: center;
cursor: pointer;
transition: all 0.2s ease;
font-size: 14px;
}

.btn-icon:hover {
transform: scale(1.1);
}

.btn-icon.edit {
background: #ffc107;
color: #333;
}

.btn-icon.delete {
background: #dc3545;
color: white;
}

.notification {
position: fixed;
top: 20px;
right: 20px;
padding: 15px 20px;
border-radius: 8px;
color: white;
font-weight: 600;
z-index: 10000;
animation: slideInRight 0.3s ease-out;
max-width: 300px;
box-shadow: 0 4px 15px rgba(0,0,0,0.2);
}

.notification.success {
background: linear-gradient(135deg, #4CAF50, #45a049);
}

.notification.error {
background: linear-gradient(135deg, #f44336, #e53935);
}

.notification.info {
background: linear-gradient(135deg, #2196F3, #1976D2);
}

.tabla-censo {
width: 100%;
border-collapse: collapse;
margin-top: 15px;
background: white;
border-radius: 8px;
overflow: hidden;
box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.tabla-censo th,
.tabla-censo td {
padding: 10px 12px;
text-align: left;
border-bottom: 1px solid #e9ecef;
font-size: 13px;
}

.tabla-censo th {
background: #e91e63;
color: white;
font-weight: 600;
}

.tabla-censo tr:hover {
background: rgba(233, 30, 99, 0.05);
}

.campo-censo, .dato-fila {
display: flex;
gap: 10px;
margin-bottom: 10px;
align-items: center;
animation: slideIn 0.3s ease-out;
}

.dato-fila {
padding: 10px;
background: #f8f9fa;
border-radius: 8px;
border: 1px solid #e9ecef;
}

.dato-fila input {
flex: 1;
padding: 8px 12px;
border: 1px solid #ddd;
border-radius: 6px;
background: white;
}

@keyframes fadeIn {
from { opacity: 0; }
to { opacity: 1; }
}

@keyframes fadeInDown {
from { opacity: 0; transform: translateY(-30px); }
to { opacity: 1; transform: translateY(0); }
}

@keyframes fadeInUp {
from { opacity: 0; transform: translateY(30px); }
to { opacity: 1; transform: translateY(0); }
}

@keyframes slideIn {
from { opacity: 0; transform: scale(0.9) translateY(-50px); }
to { opacity: 1; transform: scale(1) translateY(0); }
}

@keyframes float {
0%, 100% { transform: translateY(0) rotate(0deg); }
50% { transform: translateY(-20px) rotate(180deg); }
}

@keyframes slideInRight {
from { transform: translateX(100%); opacity: 0; }
to { transform: translateX(0); opacity: 1; }
}

@keyframes spin {
0% { transform: rotate(0deg); }
100% { transform: rotate(360deg); }
}

@media (max-width: 768px) {
.container { padding: 15px; }
.logo { padding: 20px; }
.logo h1 { font-size: 24px; }
.nav-buttons { gap: 10px; }
.nav-btn { padding: 10px 16px; font-size: 13px; }
.card { padding: 20px; margin-bottom: 15px; }
.grid { grid-template-columns: 1fr; gap: 15px; }
.modal-content { margin: 20px; padding: 20px; width: calc(100% - 40px); }
.certificate { padding: 20px; font-size: 14px; }
.residents-table { font-size: 12px; }
.residents-table th, .residents-table td { padding: 8px; }
}
</style>

<!-- Supabase Configuration -->
<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm'

const supabaseUrl = 'https://eorxvejwarymoacsasat.supabase.co'
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVvcnh2ZWp3YXJ5bW9hY3Nhc2F0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzM2OTEyODEsImV4cCI6MjA0OTI2NzI4MX0.xqE9nkf8GrfZp5qlAqaMqhXTKfcMkPuBqJxBsz9h8Qg'
const supabase = createClient(supabaseUrl, supabaseKey)

window.supabase = supabase
console.log('‚úÖ Supabase conectado correctamente')
</script>
</head>
<body>
<div class="floating-elements">
<div class="floating-circle"></div>
<div class="floating-circle"></div>
<div class="floating-circle"></div>
</div>

<div class="container">
<div class="header">
<div class="logo">
<h1>Consejo Comunal Fundo La Esperanza</h1>
<p>Filas de Mariches - Municipio Sucre - Estado Miranda</p>
<p style="font-size: 14px; margin-top: 10px;">Sistema Digital Comunitario - Powered by Supabase üöÄ</p>
</div>
</div>

<div class="nav-buttons" id="nav-buttons">
<button class="nav-btn active" onclick="showSection('residencia')">üìã Carta de Residencia</button>
<button class="nav-btn" onclick="showSection('eventos')">üìÖ Eventos</button>
<button class="nav-btn" onclick="showSection('censos')">üìä Censos</button>
<button class="nav-btn" onclick="showSection('login')" id="login-btn">üîê Panel Ejecutivo</button>
<button class="nav-btn" onclick="showSection('ejecutivo')" id="ejecutivo-btn" style="display: none;">üë§ Panel Ejecutivo</button>
<button class="nav-btn" onclick="cerrarSesion()" id="logout-btn" style="display: none;">üö™ Cerrar Sesi√≥n</button>
</div>

<!-- Secci√≥n Carta de Residencia -->
<div id="residencia" class="content-section active">
<div class="card">
<h2 style="color: #e91e63; margin-bottom: 20px; font-size: 20px;">üìã Generar Carta de Residencia</h2>
<p style="margin-bottom: 20px; color: #666; font-size: 13px;">
Ingrese su c√©dula de identidad para generar su carta de residencia.
</p>

<div class="form-group">
<label for="cedula">C√©dula de Identidad</label>
<input type="text" id="cedula" class="form-control" placeholder="Ej: V-12345678 o 12345678">
</div>

<button class="btn-primary" onclick="generarCarta()">Generar Carta de Residencia</button>

<div id="mensaje-residencia"></div>
</div>
</div>

<!-- Secci√≥n Eventos -->
<div id="eventos" class="content-section">
<div class="card">
<h2 style="color: #e91e63; margin-bottom: 20px; font-size: 20px;">üìÖ Eventos Comunitarios</h2>

<button class="btn-primary" onclick="mostrarFormularioEvento()">+ Crear Nuevo Evento</button>

<div id="lista-eventos" class="grid" style="margin-top: 30px;">
</div>
</div>
</div>

<!-- Secci√≥n Censos -->
<div id="censos" class="content-section">
<div class="card">
<h2 style="color: #e91e63; margin-bottom: 20px; font-size: 20px;">üìä Sistema de Censos Comunitarios</h2>
<p style="margin-bottom: 20px; color: #666; font-size: 13px;">
Consulte los diferentes censos y estad√≠sticas de la comunidad
</p>

<div id="censos-disponibles" class="grid">
</div>
</div>
</div>

<!-- Secci√≥n Login -->
<div id="login" class="content-section">
<div class="card" style="max-width: 400px; margin: 0 auto;">
<h2 style="color: #e91e63; margin-bottom: 20px; font-size: 20px; text-align: center;">üîê Acceso Ejecutivo</h2>

<form id="form-login">
<div class="form-group">
<label for="usuario-login">Usuario</label>
<input type="text" id="usuario-login" class="form-control" required>
</div>

<div class="form-group">
<label for="password-login">Contrase√±a</label>
<input type="password" id="password-login" class="form-control" required>
</div>

<div style="text-align: center;">
<button type="submit" class="btn-primary">Iniciar Sesi√≥n</button>
</div>
</form>

<div id="mensaje-login"></div>

<div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee; font-size: 12px; color: #666; text-align: center;">
<p><strong>Credenciales por defecto:</strong></p>
<p>Usuario: <code>admin</code> / Contrase√±a: <code>admin123</code></p>
</div>
</div>
</div>

<!-- Secci√≥n Panel Ejecutivo -->
<div id="ejecutivo" class="content-section">
<div class="card">
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
<h2 style="color: #e91e63; font-size: 20px;">üë§ Panel Ejecutivo</h2>
<div style="color: #666; font-size: 14px;">
Bienvenido, <strong id="usuario-actual"></strong>
</div>
</div>

<div class="grid" style="margin-bottom: 30px;">
<div class="card" style="background: linear-gradient(135deg, #e91e63, #f06292); color: white;">
<h3 style="margin-bottom: 15px;">üë• Gesti√≥n de Residentes</h3>
<div style="margin-bottom: 15px;">
<button class="btn-secondary" onclick="mostrarFormularioResidente()" style="background: rgba(255,255,255,0.2); color: white; border-color: rgba(255,255,255,0.3);">+ Agregar Residente</button>
</div>
</div>

<div class="card" style="background: linear-gradient(135deg, #4CAF50, #45a049); color: white;">
<h3 style="margin-bottom: 15px;">üìä Sistema de Censos</h3>
<div style="margin-bottom: 15px;">
<button class="btn-secondary" onclick="mostrarFormularioCenso()" style="background: rgba(255,255,255,0.2); color: white; border-color: rgba(255,255,255,0.3);">+ Crear Censo</button>
</div>
</div>
</div>

<!-- Configuraci√≥n (solo para admin) -->
<div id="config-admin" style="display: none;">
<div class="card" style="background: #f8f9fa; border-left: 4px solid #e91e63;">
<h3 style="color: #e91e63; margin-bottom: 20px;">‚öôÔ∏è Configuraci√≥n del Sistema</h3>

<div class="grid" style="margin-bottom: 20px;">
<div class="form-group">
<label for="gentilicio-config">Gentilicio de la Comunidad</label>
<input type="text" id="gentilicio-config" class="form-control" value="Venezolana">
<button class="btn-primary" onclick="actualizarGentilicio()" style="margin-top: 10px; padding: 8px 16px; font-size: 13px;">Actualizar</button>
</div>
</div>

<h4 style="color: #e91e63; margin: 20px 0 15px 0;">üë• Gesti√≥n de Ejecutivos</h4>
<div style="margin-bottom: 20px;">
<button class="btn-primary" onclick="mostrarFormularioEjecutivo()">+ Agregar Ejecutivo</button>
</div>

<div style="overflow-x: auto;">
<table class="residents-table">
<thead>
<tr>
<th>Usuario</th>
<th>Nombre</th>
<th>Rol</th>
<th>Estado</th>
<th>Acciones</th>
</tr>
</thead>
<tbody id="tabla-ejecutivos">
</tbody>
</table>
</div>
</div>
</div>

<!-- Tabla de Residentes -->
<div style="overflow-x: auto;">
<h3 style="color: #e91e63; margin-bottom: 15px;">üë• Residentes Registrados</h3>
<table class="residents-table">
<thead>
<tr>
<th>C√©dula</th>
<th>Nombre</th>
<th>Nacionalidad</th>
<th>Estado Civil</th>
<th>Casa N¬∞</th>
<th>Tiempo Residencia</th>
<th>Acciones</th>
</tr>
</thead>
<tbody id="tabla-residentes">
</tbody>
</table>
</div>
</div>
</div>

<!-- Modal para Carta de Residencia -->
<div id="modal-carta" class="modal">
<div class="modal-content">
<div class="certificate" id="carta-contenido">
</div>
<div style="text-align: center; margin-top: 20px;">
<button class="btn-primary" onclick="imprimirCarta()">üñ®Ô∏è Imprimir</button>
<button class="btn-secondary" onclick="cerrarModal('modal-carta')">Cerrar</button>
</div>
</div>
</div>

<!-- Modal para Eventos -->
<div id="modal-evento" class="modal">
<div class="modal-content">
<h3 style="color: #e91e63; margin-bottom: 20px;">üìÖ Crear/Editar Evento</h3>
<form id="form-evento">
<div class="form-group">
<label for="titulo-evento">T√≠tulo del Evento</label>
<input type="text" id="titulo-evento" class="form-control" required>
</div>

<div class="form-group">
<label for="fecha-evento">Fecha</label>
<input type="date" id="fecha-evento" class="form-control" required>
</div>

<div class="form-group">
<label for="hora-evento">Hora</label>
<input type="time" id="hora-evento" class="form-control" required>
</div>

<div class="form-group">
<label for="descripcion-evento">Descripci√≥n</label>
<textarea id="descripcion-evento" class="form-control" rows="3"></textarea>
</div>

<div class="form-group">
<label for="lugar-evento">Lugar</label>
<input type="text" id="lugar-evento" class="form-control">
</div>

<div style="text-align: center; margin-top: 20px;">
<button type="submit" class="btn-primary">Guardar Evento</button>
<button type="button" class="btn-secondary" onclick="cerrarModal('modal-evento')">Cancelar</button>
</div>
</form>
</div>
</div>

<!-- Modal para Residentes -->
<div id="modal-residente" class="modal">
<div class="modal-content">
<h3 style="color: #e91e63; margin-bottom: 20px;">üë§ Agregar/Editar Residente</h3>
<form id="form-residente">
<div class="form-group">
<label for="cedula-residente">C√©dula de Identidad</label>
<input type="text" id="cedula-residente" class="form-control" required>
</div>

<div class="form-group">
<label for="nombre-residente">Nombre Completo</label>
<input type="text" id="nombre-residente" class="form-control" required>
</div>

<div class="form-group">
<label for="nacionalidad-residente">Nacionalidad</label>
<select id="nacionalidad-residente" class="form-control">
<option value="Venezolana">Venezolana</option>
<option value="Colombiana">Colombiana</option>
<option value="Peruana">Peruana</option>
<option value="Otra">Otra</option>
</select>
</div>

<div class="form-group">
<label for="estado-civil-residente">Estado Civil</label>
<select id="estado-civil-residente" class="form-control">
<option value="Soltero(a)">Soltero(a)</option>
<option value=">Casado(a)</option>
<option value="Divorciado(a)">Divorciado(a)</option>
<option value="Viudo(a)">Viudo(a)</option>
<option value="Uni√≥n Libre">Uni√≥n Libre</option>
</select>
</div>

<div class="form-group">
<label for="casa-residente">Casa N¬∞</label>
<input type="text" id="casa-residente" class="form-control" required>
</div>

<div class="form-group">
<label for="tiempo-residencia">Tiempo de Residencia</label>
<input type="text" id="tiempo-residencia" class="form-control" placeholder="Ej: 3 a√±os">
</div>

<div style="text-align: center; margin-top: 20px;">
<button type="submit" class="btn-primary">Guardar Residente</button>
<button type="button" class="btn-secondary" onclick="cerrarModal('modal-residente')">Cancelar</button>
</div>
</form>
</div>
</div>

<!-- Modal para Ejecutivos -->
<div id="modal-ejecutivo" class="modal">
<div class="modal-content">
<h3 style="color: #e91e63; margin-bottom: 20px;">üë§ Agregar/Editar Ejecutivo</h3>
<form id="form-ejecutivo">
<div class="form-group">
<label for="usuario-ejecutivo">Usuario</label>
<input type="text" id="usuario-ejecutivo" class="form-control" required>
</div>

<div class="form-group">
<label for="nombre-ejecutivo">Nombre Completo</label>
<input type="text" id="nombre-ejecutivo" class="form-control" required>
</div>

<div class="form-group">
<label for="password-ejecutivo">Contrase√±a</label>
<input type="password" id="password-ejecutivo" class="form-control" required>
</div>

<div class="form-group">
<label for="rol-ejecutivo">Rol</label>
<select id="rol-ejecutivo" class="form-control">
<option value="ejecutivo">Ejecutivo</option>
<option value="admin">Administrador</option>
</select>
</div>

<div style="text-align: center; margin-top: 20px;">
<button type="submit" class="btn-primary">Guardar Ejecutivo</button>
<button type="button" class="btn-secondary" onclick="cerrarModal('modal-ejecutivo')">Cancelar</button>
</div>
</form>
</div>
</div>

<!-- Modal para Censos -->
<div id="modal-censo" class="modal">
<div class="modal-content" style="max-width: 800px; max-height: 90vh;">
<h3 style="color: #e91e63; margin-bottom: 20px;" id="titulo-censo">üìä Datos del Censo</h3>
<div id="contenido-censo" style="max-height: 60vh; overflow-y: auto;">
</div>
<div style="text-align: center; margin-top: 20px;">
<button class="btn-primary" onclick="exportarCenso()">üì• Exportar</button>
<button class="btn-secondary" onclick="cerrarModal('modal-censo')">Cerrar</button>
</div>
</div>
</div>

<!-- Modal para Crear Censo -->
<div id="modal-crear-censo" class="modal">
<div class="modal-content" style="max-width: 600px;">
<h3 style="color: #e91e63; margin-bottom: 20px;">üìä Crear Censo</h3>
<form id="form-censo">
<div class="form-group">
<label for="nombre-censo">Nombre del Censo</label>
<input type="text" id="nombre-censo" class="form-control" required placeholder="Ej: Censo de Ni√±os por Edades">
</div>

<div class="form-group">
<label for="tipo-censo">Tipo de Censo</label>
<select id="tipo-censo" class="form-control" required>
<option value="">Seleccionar tipo</option>
<option value="poblacion">Poblaci√≥n</option>
<option value="vivienda">Vivienda</option>
<option value="servicios">Servicios</option>
<option value="educacion">Educaci√≥n</option>
<option value="salud">Salud</option>
<option value="economia">Econom√≠a</option>
<option value="otro">Otro</option>
</select>
</div>

<div class="form-group">
<label for="descripcion-censo">Descripci√≥n</label>
<textarea id="descripcion-censo" class="form-control" rows="3" placeholder="Descripci√≥n del censo"></textarea>
</div>

<div class="form-group">
<label>Datos del Censo</label>
<div id="campos-censo">
<div class="campo-censo">
<input type="text" class="form-control campo-nombre" placeholder="Campo" style="flex: 1;">
<input type="text" class="form-control campo-valor" placeholder="Valor" style="flex: 1;">
<button type="button" class="btn-danger" onclick="eliminarCampoCenso(this)">üóëÔ∏è</button>
</div>
</div>
<button type="button" class="btn-secondary" onclick="agregarCampoCenso()" style="margin-top: 10px;">+ Agregar Campo</button>
</div>

<div style="text-align: center; margin-top: 20px;">
<button type="submit" class="btn-primary">Guardar Censo</button>
<button type="button" class="btn-secondary" onclick="cerrarModal('modal-crear-censo')">Cancelar</button>
</div>
</form>
</div>
</div>

<!-- Modal para Editar Censo -->
<div id="modal-editar-censo" class="modal">
<div class="modal-content" style="max-width: 700px; max-height: 90vh;">
<h3 style="color: #e91e63; margin-bottom: 20px;">‚úèÔ∏è Editar Datos del Censo</h3>
<div style="max-height: 60vh; overflow-y: auto;">
<form id="form-editar-censo">
<div class="form-group">
<label for="nombre-censo-edit">Nombre del Censo</label>
<input type="text" id="nombre-censo-edit" class="form-control" required>
</div>

<div class="form-group">
<label for="tipo-censo-edit">Tipo</label>
<select id="tipo-censo-edit" class="form-control" required>
<option value="poblacion">Poblaci√≥n</option>
<option value="vivienda">Vivienda</option>
<option value="servicios">Servicios</option>
<option value="educacion">Educaci√≥n</option>
<option value="salud">Salud</option>
<option value="economia">Econom√≠a</option>
<option value="otro">Otro</option>
</select>
</div>

<div class="form-group">
<label for="descripcion-censo-edit">Descripci√≥n</label>
<textarea id="descripcion-censo-edit" class="form-control" rows="2"></textarea>
</div>

<div class="form-group">
<label>Datos del Censo</label>
<div id="datos-censo-edit">
</div>
<button type="button" class="btn-secondary" onclick="agregarFilaDatos()" style="margin-top: 10px;">+ Agregar Fila</button>
</div>
</form>
</div>
<div style="text-align: center; margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee;">
<button class="btn-primary" onclick="guardarCambiosCenso()">üíæ Guardar Cambios</button>
<button class="btn-danger" onclick="eliminarCensoCompleto()" style="margin-left: 10px;">üóëÔ∏è Eliminar Censo</button>
<button class="btn-secondary" onclick="cerrarModal('modal-editar-censo')" style="margin-left: 10px;">Cancelar</button>
</div>
</div>
</div>

<!-- Loading Overlay -->
<div id="loading-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; align-items: center; justify-content: center;">
<div style="background: white; padding: 30px; border-radius: 15px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
<div style="width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #e91e63; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 15px;"></div>
<p style="color: #333; font-weight: 600;">Cargando datos...</p>
</div>
</div>

<script>
// Variables globales
let residentes = [];
let eventos = [];
let ejecutivos = [];
let censos = [];
let configuracion = { gentilicio: 'Venezolana' };
let sesionActiva = null;
let eventoEditando = null;
let residenteEditando = null;
let ejecutivoEditando = null;
let censoEditando = null;

// Inicializaci√≥n
document.addEventListener('DOMContentLoaded', function() {
    inicializarSistema();
});

async function inicializarSistema() {
    mostrarLoading(true);
    try {
        await cargarDatosIniciales();
        configurarEventListeners();
        await cargarEventos();
        await cargarResidentes();
        await cargarCensos();
        verificarSesion();
        mostrarNotificacion('Sistema inicializado correctamente ‚úÖ', 'success');
    } catch (error) {
        console.error('Error al inicializar:', error);
        mostrarNotificacion('Error al cargar datos del sistema', 'error');
    }
    mostrarLoading(false);
}

async function cargarDatosIniciales() {
    try {
        const { data: ejecutivosData, error: ejecutivosError } = await window.supabase
            .from('ejecutivos')
            .select('*');
        
        if (ejecutivosError) throw ejecutivosError;
        ejecutivos = ejecutivosData || [];

        const { data: residentesData, error: residentesError } = await window.supabase
            .from('residentes')
            .select('*');
        
        if (residentesError) throw residentesError;
        residentes = residentesData || [];

        const { data: eventosData, error: eventosError } = await window.supabase
            .from('eventos')
            .select('*')
            .order('fecha', { ascending: true });
        
        if (eventosError) throw eventosError;
        eventos = eventosData || [];

        const { data: censosData, error: censosError } = await window.supabase
            .from('censos')
            .select('*')
            .order('created_at', { ascending: false });
        
        if (censosError) throw censosError;
        censos = censosData || [];

        const { data: configData, error: configError } = await window.supabase
            .from('configuracion')
            .select('*')
            .limit(1);
        
        if (configError) throw configError;
        if (configData && configData.length > 0) {
            configuracion = configData[0];
        }

        console.log('‚úÖ Datos cargados:', { 
            ejecutivos: ejecutivos.length, 
            residentes: residentes.length, 
            eventos: eventos.length, 
            censos: censos.length 
        });
    } catch (error) {
        console.error('Error cargando datos:', error);
        throw error;
    }
}

function configurarEventListeners() {
    document.getElementById('cedula').addEventListener('input', function(e) {
        formatearCedula(e.target);
    });

    document.getElementById('cedula-residente').addEventListener('input', function(e) {
        formatearCedula(e.target);
    });

    document.getElementById('form-login').addEventListener('submit', manejarLogin);
    document.getElementById('form-evento').addEventListener('submit', manejarEvento);
    document.getElementById('form-residente').addEventListener('submit', manejarResidente);
    document.getElementById('form-ejecutivo').addEventListener('submit', manejarEjecutivo);
    document.getElementById('form-censo').addEventListener('submit', manejarCenso);

    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            document.querySelectorAll('.modal.active').forEach(modal => {
                modal.classList.remove('active');
            });
        }
    });

    document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                modal.classList.remove('active');
            }
        });
    });
}

function showSection(section) {
    if (section === 'ejecutivo' && !sesionActiva) {
        showSection('login');
        return;
    }

    document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));

    document.getElementById(section).classList.add('active');

    const targetBtn = section === 'ejecutivo' ? 'ejecutivo-btn' :
                     section === 'login' ? 'login-btn' :
                     document.querySelector(`[onclick="showSection('${section}')"]`);

    if (typeof targetBtn === 'string') {
        document.getElementById(targetBtn).classList.add('active');
    } else if (targetBtn) {
        targetBtn.classList.add('active');
    }
}

async function manejarLogin(e) {
    e.preventDefault();
    const usuario = document.getElementById('usuario-login').value.trim();
    const password = document.getElementById('password-login').value.trim();
    const mensajeDiv = document.getElementById('mensaje-login');

    if (!usuario || !password) {
        mensajeDiv.innerHTML = '<div class="error-message">Complete todos los campos</div>';
        return;
    }

    const ejecutivo = ejecutivos.find(e => e.usuario === usuario && e.password === password && e.activo);

    if (!ejecutivo) {
        mensajeDiv.innerHTML = '<div class="error-message">Credenciales incorrectas</div>';
        return;
    }

    sesionActiva = ejecutivo;
    verificarSesion();
    showSection('ejecutivo');
    mensajeDiv.innerHTML = '<div class="success-message">Sesi√≥n iniciada correctamente</div>';
    document.getElementById('form-login').reset();
    mostrarNotificacion(`Bienvenido, ${ejecutivo.nombre}`, 'success');
}

function verificarSesion() {
    if (sesionActiva) {
        document.getElementById('login-btn').style.display = 'none';
        document.getElementById('ejecutivo-btn').style.display = 'block';
        document.getElementById('logout-btn').style.display = 'block';
        document.getElementById('usuario-actual').textContent = sesionActiva.nombre;

        if (sesionActiva.rol === 'admin') {
            document.getElementById('config-admin').style.display = 'block';
            cargarEjecutivos();
            document.getElementById('gentilicio-config').value = configuracion.gentilicio;
        }
    } else {
        document.getElementById('login-btn').style.display = 'block';
        document.getElementById('ejecutivo-btn').style.display = 'none';
        document.getElementById('logout-btn').style.display = 'none';
        document.getElementById('config-admin').style.display = 'none';
    }
}

function cerrarSesion() {
    sesionActiva = null;
    verificarSesion();
    showSection('residencia');
    mostrarNotificacion('Sesi√≥n cerrada correctamente', 'info');
}

async function cargarResidentes() {
    const tablaBody = document.getElementById('tabla-residentes');

    if (residentes.length === 0) {
        tablaBody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #666;">No hay residentes registrados</td></tr>';
        return;
    }

    tablaBody.innerHTML = residentes.map(residente => `
        <tr>
            <td>${residente.cedula}</td>
            <td>${residente.nombre}</td>
            <td>${residente.nacionalidad}</td>
            <td>${residente.estado_civil}</td>
            <td>${residente.casa}</td>
            <td>${residente.tiempo_residencia}</td>
            <td>
                <button class="btn-secondary" style="margin-right: 5px; padding: 6px 12px; font-size: 11px;"
                    onclick='editarResidente(${JSON.stringify(residente)})'>Editar</button>
                <button class="btn-danger" style="padding: 6px 12px; font-size: 11px;"
                    onclick="eliminarResidente('${residente.id}')">Eliminar</button>
            </td>
        </tr>
    `).join('');
}

async function manejarResidente(e) {
    e.preventDefault();
    mostrarLoading(true);

    try {
        let cedula = document.getElementById('cedula-residente').value.trim();

        if (!cedula.startsWith('V-') && /^\d+$/.test(cedula)) {
            cedula = 'V-' + cedula;
        }

        const residente = {
            cedula: cedula,
            nombre: document.getElementById('nombre-residente').value,
            nacionalidad: document.getElementById('nacionalidad-residente').value,
            estado_civil: document.getElementById('estado-civil-residente').value,
            casa: document.getElementById('casa-residente').value,
            tiempo_residencia: document.getElementById('tiempo-residencia').value
        };

        if (residenteEditando) {
            const { error } = await window.supabase
                .from('residentes')
                .update(residente)
                .eq('id', residenteEditando.id);

            if (error) throw error;

            const index = residentes.findIndex(r => r.id === residenteEditando.id);
            residentes[index] = { ...residente, id: residenteEditando.id };
            mostrarNotificacion('Residente actualizado correctamente', 'success');
        } else {
            if (residentes.find(r => r.cedula === cedula)) {
                mostrarNotificacion('Ya existe un residente con esta c√©dula', 'error');
                mostrarLoading(false);
                return;
            }

            const { data, error } = await window.supabase
                .from('residentes')
                .insert([residente])
                .select();

            if (error) throw error;

            residentes.push(data[0]);
            mostrarNotificacion('Residente agregado correctamente', 'success');
        }

        await cargarResidentes();
        cerrarModal('modal-residente');
        residenteEditando = null;
    } catch (error) {
        console.error('Error al guardar residente:', error);
        mostrarNotificacion('Error al guardar el residente', 'error');
    }
    mostrarLoading(false);
}

function editarResidente(residente) {
    residenteEditando = residente;
    document.getElementById('cedula-residente').value = residente.cedula;
    document.getElementById('nombre-residente').value = residente.nombre;
    document.getElementById('nacionalidad-residente').value = residente.nacionalidad;
    document.getElementById('estado-civil-residente').value = residente.estado_civil;
    document.getElementById('casa-residente').value = residente.casa;
    document.getElementById('tiempo-residencia').value = residente.tiempo_residencia;
    document.getElementById('modal-residente').classList.add('active');
}

async function eliminarResidente(id) {
    if (!confirm('¬øEst√° seguro de que desea eliminar este residente?')) return;

    mostrarLoading(true);
    try {
        const { error } = await window.supabase
            .from('residentes')
            .delete()
            .eq('id', id);

        if (error) throw error;

        residentes = residentes.filter(r => r.id !== id);
        await cargarResidentes();
        mostrarNotificacion('Residente eliminado correctamente', 'success');
    } catch (error) {
        console.error('Error al eliminar residente:', error);
        mostrarNotificacion('Error al eliminar el residente', 'error');
    }
    mostrarLoading(false);
}

async function cargarEventos() {
    const listaEventos = document.getElementById('lista-eventos');

    if (eventos.length === 0) {
        listaEventos.innerHTML = '<p style="text-align: center; color: #666; grid-column: 1/-1;">No hay eventos programados</p>';
        return;
    }

    listaEventos.innerHTML = eventos.map(evento => `
        <div class="event-card">
            <div class="event-date">${formatearFecha(evento.fecha)} - ${evento.hora}</div>
            <h4 style="color: #e91e63; margin: 10px 0;">${evento.titulo}</h4>
            <p style="color: #666; font-size: 13px; margin: 10px 0;">${evento.descripcion || 'Sin descripci√≥n'}</p>
            ${evento.lugar ? `<p style="color: #888; font-size: 12px;"><strong>üìç ${evento.lugar}</strong></p>` : ''}
            ${sesionActiva ? `<div style="margin-top: 15px;">
                <button class="btn-secondary" onclick='editarEvento(${JSON.stringify(evento)})'>Editar</button>
                <button class="btn-danger" onclick="eliminarEvento('${evento.id}')">Eliminar</button>
            </div>` : ''}
        </div>
    `).join('');
}

async function manejarEvento(e) {
    e.preventDefault();
    mostrarLoading(true);

    try {
        const evento = {
            titulo: document.getElementById('titulo-evento').value,
            fecha: document.getElementById('fecha-evento').value,
            hora: document.getElementById('hora-evento').value,
            descripcion: document.getElementById('descripcion-evento').value,
            lugar: document.getElementById('lugar-evento').value
        };

        if (eventoEditando) {
            const { error } = await window.supabase
                .from('eventos')
                .update(evento)
                .eq('id', eventoEditando.id);

            if (error) throw error;

            const index = eventos.findIndex(e => e.id === eventoEditando.id);
            eventos[index] = { ...evento, id: eventoEditando.id };
            mostrarNotificacion('Evento actualizado correctamente', 'success');
        } else {
            const { data, error } = await window.supabase
                .from('eventos')
                .insert([evento])
                .select();

            if (error) throw error;

            eventos.push(data[0]);
            mostrarNotificacion('Evento creado correctamente', 'success');
        }

        await cargarEventos();
        cerrarModal('modal-evento');
        eventoEditando = null;
    } catch (error) {
        console.error('Error al guardar evento:', error);
        mostrarNotificacion('Error al guardar el evento', 'error');
    }
    mostrarLoading(false);
}

function editarEvento(evento) {
    eventoEditando = evento;
    document.getElementById('titulo-evento').value = evento.titulo;
    document.getElementById('fecha-evento').value = evento.fecha;
    document.getElementById('hora-evento').value = evento.hora;
    document.getElementById('descripcion-evento').value = evento.descripcion || '';
    document.getElementById('lugar-evento').value = evento.lugar || '';
    document.getElementById('modal-evento').classList.add('active');
}

async function eliminarEvento(id) {
    if (!confirm('¬øEst√° seguro de que desea eliminar este evento?')) return;

    mostrarLoading(true);
    try {
        const { error } = await window.supabase
            .from('eventos')
            .delete()
            .eq('id', id);

        if (error) throw error;

        eventos = eventos.filter(e => e.id !== id);
        await cargarEventos();
        mostrarNotificacion('Evento eliminado correctamente', 'success');
    } catch (error) {
        console.error('Error al eliminar evento:', error);
        mostrarNotificacion('Error al eliminar el evento', 'error');
    }
    mostrarLoading(false);
}

async function cargarCensos() {
    const censosDiv = document.getElementById('censos-disponibles');

    if (censos.length === 0) {
        censosDiv.innerHTML = '<p style="text-align: center; color: #666; grid-column: 1/-1;">No hay censos disponibles</p>';
        return;
    }

    censosDiv.innerHTML = censos.map(censo => `
        <div class="censo-card" onclick="verCenso('${censo.id}')">
            ${sesionActiva ? `<div class="censo-card-actions">
                <button class="btn-icon edit" onclick="event.stopPropagation(); editarCenso('${censo.id}')" title="Editar">‚úèÔ∏è</button>
                <button class="btn-icon delete" onclick="event.stopPropagation(); eliminarCenso('${censo.id}')" title="Eliminar">üóëÔ∏è</button>
            </div>` : ''}
            <h3>${censo.nombre}</h3>
            <p>Tipo: ${censo.tipo.charAt(0).toUpperCase() + censo.tipo.slice(1)}</p>
            <p>Fecha: ${formatearFecha(censo.fecha)}</p>
            ${censo.descripcion ? `<p>Descripci√≥n: ${censo.descripcion}</p>` : ''}
            <div class="censo-info-badge">
                ${Array.isArray(censo.datos) ? censo.datos.length : Object.keys(censo.datos || {}).length} registros
            </div>
        </div>
    `).join('');
}

async function manejarCenso(e) {
    e.preventDefault();
    mostrarLoading(true);

    try {
        const campos = document.querySelectorAll('.campo-censo');
        const datos = [];

        campos.forEach(campo => {
            const nombre = campo.querySelector('.campo-nombre').value.trim();
            const valor = campo.querySelector('.campo-valor').value.trim();
            if (nombre && valor) {
                datos.push({ [nombre]: valor });
            }
        });

        const censo = {
            nombre: document.getElementById('nombre-censo').value,
            tipo: document.getElementById('tipo-censo').value,
            descripcion: document.getElementById('descripcion-censo').value,
            fecha: new Date().toISOString().split('T')[0],
            datos: datos
        };

        const { data, error } = await window.supabase
            .from('censos')
            .insert([censo])
            .select();

        if (error) throw error;

        censos.unshift(data[0]);
        await cargarCensos();
        cerrarModal('modal-crear-censo');
        mostrarNotificacion('Censo creado correctamente', 'success');
    } catch (error) {
        console.error('Error al crear censo:', error);
        mostrarNotificacion('Error al crear el censo', 'error');
    }
    mostrarLoading(false);
}

function verCenso(id) {
    const censo = censos.find(c => c.id === id);
    if (!censo) return;

    document.getElementById('titulo-censo').textContent = `üìä ${censo.nombre}`;

    let contenido = `
        <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 10px;">
            <strong>Fecha del censo:</strong> ${formatearFecha(censo.fecha)}<br>
            <strong>Tipo:</strong> ${censo.tipo.charAt(0).toUpperCase() + censo.tipo.slice(1)}<br>
            ${censo.descripcion ? `<strong>Descripci√≥n:</strong> ${censo.descripcion}<br>` : ''}
            <strong>Total de registros:</strong> ${Array.isArray(censo.datos) ? censo.datos.length : Object.keys(censo.datos || {}).length}
        </div>
    `;

    if (Array.isArray(censo.datos) && censo.datos.length > 0) {
        const keys = Object.keys(censo.datos[0]);
        contenido += `
            <div style="overflow-x: auto;">
                <table class="tabla-censo">
                    <thead><tr>
                        ${keys.map(key => `<th>${key.charAt(0).toUpperCase() + key.slice(1)}</th>`).join('')}
                    </tr></thead>
                    <tbody>
                        ${censo.datos.map(fila => `<tr>${Object.values(fila).map(valor => `<td>${valor}</td>`).join('')}</tr>`).join('')}
                    </tbody>
                </table>
            </div>
        `;
    } else {
        contenido += '<p style="text-align: center; color: #666;">No hay datos disponibles</p>';
    }

    document.getElementById('contenido-censo').innerHTML = contenido;
    document.getElementById('modal-censo').classList.add('active');
}

async function editarCenso(id) {
    const censo = censos.find(c => c.id === id);
    if (!censo) return;

    censoEditando = censo;

    document.getElementById('nombre-censo-edit').value = censo.nombre;
    document.getElementById('tipo-censo-edit').value = censo.tipo;
    document.getElementById('descripcion-censo-edit').value = censo.descripcion || '';

    const datosDiv = document.getElementById('datos-censo-edit');
    datosDiv.innerHTML = '';

    if (Array.isArray(censo.datos)) {
        censo.datos.forEach(dato => {
            const keys = Object.keys(dato);
            const values = Object.values(dato);

            const filaDiv = document.createElement('div');
            filaDiv.className = 'dato-fila';
            filaDiv.innerHTML = `
                <input type="text" value="${keys[0] || ''}" placeholder="Campo" class="dato-campo">
                <input type="text" value="${values[0] || ''}" placeholder="Valor" class="dato-valor">
                <button type="button" class="btn-danger" onclick="eliminarFilaDatos(this)">üóëÔ∏è</button>
            `;
            datosDiv.appendChild(filaDiv);
        });
    }

    document.getElementById('modal-editar-censo').classList.add('active');
}

async function guardarCambiosCenso() {
    if (!censoEditando) return;

    mostrarLoading(true);
    try {
        const filas = document.querySelectorAll('.dato-fila');
        const datos = [];

        filas.forEach(fila => {
            const campo = fila.querySelector('.dato-campo').value.trim();
            const valor = fila.querySelector('.dato-valor').value.trim();
            if (campo && valor) {
                datos.push({ [campo]: valor });
            }
        });

        const censoActualizado = {
            nombre: document.getElementById('nombre-censo-edit').value,
            tipo: document.getElementById('tipo-censo-edit').value,
            descripcion: document.getElementById('descripcion-censo-edit').value,
            datos: datos
        };

        const { error } = await window.supabase
            .from('censos')
            .update(censoActualizado)
            .eq('id', censoEditando.id);

        if (error) throw error;

        const index = censos.findIndex(c => c.id === censoEditando.id);
        censos[index] = { ...censos[index], ...censoActualizado };

        await cargarCensos();
        cerrarModal('modal-editar-censo');
        censoEditando = null;
        mostrarNotificacion('Censo actualizado correctamente', 'success');
    } catch (error) {
        console.error('Error al actualizar censo:', error);
        mostrarNotificacion('Error al actualizar el censo', 'error');
    }
    mostrarLoading(false);
}

async function eliminarCenso(id) {
    if (!confirm('¬øEst√° seguro de que desea eliminar este censo?')) return;

    mostrarLoading(true);
    try {
        const { error } = await window.supabase
            .from('censos')
            .delete()
            .eq('id', id);

        if (error) throw error;

        censos = censos.filter(c => c.id !== id);
        await cargarCensos();
        mostrarNotificacion('Censo eliminado correctamente', 'success');
    } catch (error) {
        console.error('Error al eliminar censo:', error);
        mostrarNotificacion('Error al eliminar el censo', 'error');
    }
    mostrarLoading(false);
}

async function eliminarCensoCompleto() {
    if (!censoEditando) return;
    await eliminarCenso(censoEditando.id);
    cerrarModal('modal-editar-censo');
    censoEditando = null;
}

async function cargarEjecutivos() {
    const tablaBody = document.getElementById('tabla-ejecutivos');

    tablaBody.innerHTML = ejecutivos.map(ejecutivo => `
        <tr>
            <td>${ejecutivo.usuario}</td>
            <td>${ejecutivo.nombre}</td>
            <td><span style="padding: 4px 8px; border-radius: 4px; font-size: 11px; background: ${ejecutivo.rol === 'admin' ? '#e91e63' : '#4CAF50'}; color: white;">${ejecutivo.rol.toUpperCase()}</span></td>
            <td><span style="padding: 4px 8px; border-radius: 4px; font-size: 11px; background: ${ejecutivo.activo ? '#4CAF50' : '#f44336'}; color: white;">${ejecutivo.activo ? 'Activo' : 'Inactivo'}</span></td>
            <td>
                <button class="btn-secondary" style="margin-right: 5px; padding: 6px 12px; font-size: 11px;"
                    onclick='editarEjecutivo(${JSON.stringify(ejecutivo)})'>Editar</button>
                ${ejecutivo.usuario !== 'admin' ? `<button class="btn-danger" style="padding: 6px 12px; font-size: 11px;"
                    onclick="toggleEjecutivo('${ejecutivo.id}')">${ejecutivo.activo ? 'Desactivar' : 'Activar'}</button>` : ''}
            </td>
        </tr>
    `).join('');
}

async function manejarEjecutivo(e) {
    e.preventDefault();
    mostrarLoading(true);

    try {
        const usuario = document.getElementById('usuario-ejecutivo').value.trim();
        const ejecutivo = {
            usuario: usuario,
            password: document.getElementById('password-ejecutivo').value,
            nombre: document.getElementById('nombre-ejecutivo').value,
            rol: document.getElementById('rol-ejecutivo').value,
            activo: true
        };

        if (ejecutivoEditando) {
            const { error } = await window.supabase
                .from('ejecutivos')
                .update(ejecutivo)
                .eq('id', ejecutivoEditando.id);

            if (error) throw error;

            const index = ejecutivos.findIndex(e => e.id === ejecutivoEditando.id);
            ejecutivos[index] = { ...ejecutivo, id: ejecutivoEditando.id };
            mostrarNotificacion('Ejecutivo actualizado correctamente', 'success');
        } else {
            if (ejecutivos.find(e => e.usuario === usuario)) {
                mostrarNotificacion('Ya existe un ejecutivo con este usuario', 'error');
                mostrarLoading(false);
                return;
            }

            const { data, error } = await window.supabase
                .from('ejecutivos')
                .insert([ejecutivo])
                .select();

            if (error) throw error;

            ejecutivos.push(data[0]);
            mostrarNotificacion('Ejecutivo agregado correctamente', 'success');
        }

        await cargarEjecutivos();
        cerrarModal('modal-ejecutivo');
        ejecutivoEditando = null;
    } catch (error) {
        console.error('Error al guardar ejecutivo:', error);
        mostrarNotificacion('Error al guardar el ejecutivo', 'error');
    }
    mostrarLoading(false);
}

function editarEjecutivo(ejecutivo) {
    ejecutivoEditando = ejecutivo;
    document.getElementById('usuario-ejecutivo').value = ejecutivo.usuario;
    document.getElementById('nombre-ejecutivo').value = ejecutivo.nombre;
    document.getElementById('password-ejecutivo').value = ejecutivo.password;
    document.getElementById('rol-ejecutivo').value = ejecutivo.rol;
    document.getElementById('modal-ejecutivo').classList.add('active');
}

async function toggleEjecutivo(id) {
    mostrarLoading(true);
    try {
        const ejecutivo = ejecutivos.find(e => e.id === id);
        if (ejecutivo) {
            ejecutivo.activo = !ejecutivo.activo;

            const { error } = await window.supabase
                .from('ejecutivos')
                .update({ activo: ejecutivo.activo })
                .eq('id', ejecutivo.id);

            if (error) throw error;

            await cargarEjecutivos();
            mostrarNotificacion(`Ejecutivo ${ejecutivo.activo ? 'activado' : 'desactivado'} correctamente`, 'success');
        }
    } catch (error) {
        console.error('Error al cambiar estado del ejecutivo:', error);
        mostrarNotificacion('Error al cambiar el estado del ejecutivo', 'error');
    }
    mostrarLoading(false);
}

async function generarCarta() {
    const cedula = document.getElementById('cedula').value.trim();
    const mensajeDiv = document.getElementById('mensaje-residencia');

    if (!cedula) {
        mensajeDiv.innerHTML = '<div class="error-message">Por favor ingrese su c√©dula de identidad</div>';
        return;
    }

    let cedulaFormateada = cedula;
    if (!cedula.startsWith('V-') && /^\d+$/.test(cedula)) {
        cedulaFormateada = 'V-' + cedula;
    }

    const residente = residentes.find(r => r.cedula === cedulaFormateada);

    if (!residente) {
        mensajeDiv.innerHTML = '<div class="error-message">C√©dula no encontrada en el registro de residentes. Contacte al administrador.</div>';
        return;
    }

    const fechaActual = new Date();
    const dia = fechaActual.getDate();
    const mes = fechaActual.toLocaleString('es-ES', { month: 'long' });
    const a√±o = fechaActual.getFullYear();

    const cartaHTML = `
        <div class="certificate-header">
            <img src="https://i.postimg.cc/SsGkdCGQ/imagen-2024-12-11-202032539.png" alt="Membrete Oficial" class="membrete-imagen">
            <h2><strong>REP√öBLICA BOLIVARIANA DE VENEZUELA</strong></h2>
            <h2><strong>Consejo Comunal "Fundo La Esperanza"</strong></h2>
            <h2><strong>Parroquia Filas de Mariches -- Municipio Sucre -- Estado Miranda</strong></h2>
            <h2><strong>RIF: J-40522948-9</strong></h2>
        </div>

        <h3 style="text-align: center;"><strong>CONSTANCIA DE RESIDENCIA</strong></h3>

        <p style="text-align: justify; margin: 20px 0;">
            Por medio de la presente, el Consejo Comunal "Fundo La Esperanza" hace constar que el(la) ciudadano(a)
            <strong>${residente.nombre}</strong>, titular de la C√©dula de Identidad N¬∞ <strong>${residente.cedula}</strong>,
            de nacionalidad <strong>${configuracion.gentilicio}</strong> y estado civil <strong>${residente.estado_civil}</strong>,
            reside en esta comunidad desde hace aproximadamente <strong>${residente.tiempo_residencia}</strong>,
            en la vivienda ubicada en la casa N¬∞ <strong>${residente.casa}</strong>.
        </p>

        <p style="text-align: justify; margin: 20px 0;">
            Durante su permanencia en el sector, ha demostrado ser una persona de conducta intachable y de buenas costumbres,
            manteniendo una relaci√≥n cordial y respetuosa con sus vecinos.
        </p>

        <p style="text-align: justify; margin: 20px 0;">
            Se expide la presente constancia a solicitud de la parte interesada, en <strong>Mariche</strong>,
            a los <strong>${dia}</strong> d√≠as del mes de <strong>${mes}</strong> del a√±o <strong>${a√±o}</strong>,
            para los fines legales que estime convenientes.
        </p>

        <div style="margin-top: 40px;">
            <p><strong>Atentamente,</strong></p>
            <br>
            <div style="display: flex; justify-content: space-between; margin-top: 40px;">
                <div style="text-align: center;">
                    <p><strong>Pablo Ortega</strong><br>
                    C.I. V-13.711.426<br>
                    Comit√© de Tierra, Vivienda y H√°bitat</p>
                </div>
                <div style="text-align: center;">
                    <p><strong>Yamilet Rangel</strong><br>
                    C.I. V-10.542.222<br>
                    Unidad de Contralor√≠a</p>
                </div>
            </div>
        </div>

        <div style="margin-top: 40px; border-top: 1px solid #ccc; padding-top: 20px;">
            <p style="font-size: 12px;">
                <strong>Direcci√≥n:</strong> Carretera Petare--Santa Luc√≠a, km 12. Sector Fundo La Esperanza,
                Filas de Mariche, Municipio Sucre, Estado Miranda. <strong>Zona Postal:</strong> 1073<br>
                <strong>Tel√©fonos:</strong> 0412-920.4454 / 0412-974.5777
            </p>
            <p style="font-size: 12px; margin-top: 10px;"><strong>Nota:</strong> Esta constancia tiene una validez de seis (6) meses a partir de la fecha de emisi√≥n.</p>
        </div>
    `;

    document.getElementById('carta-contenido').innerHTML = cartaHTML;
    document.getElementById('modal-carta').classList.add('active');

    mensajeDiv.innerHTML = '<div class="success-message">Carta de residencia generada exitosamente</div>';
}

function imprimirCarta() {
    const contenido = document.getElementById('carta-contenido').innerHTML;
    const ventana = window.open('', '_blank');
    ventana.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
            <title>Carta de Residencia</title>
            <style>
                body { font-family: 'Times New Roman', serif; margin: 40px; line-height: 1.6; }
                .certificate-header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #333; padding-bottom: 20px; }
                .membrete-imagen { width: 100%; max-width: 500px; height: auto; margin-bottom: 15px; }
                h2 { font-size: 16px; margin: 5px 0; }
                h3 { font-size: 18px; text-decoration: underline; text-align: center; margin: 20px 0; }
                p { text-align: justify; margin: 15px 0; }
                @media print { body { margin: 20px; } }
            </style>
        </head>
        <body>${contenido}</body>
        </html>
    `);
    ventana.document.close();
    ventana.print();
}

function formatearCedula(input) {
    let valor = input.value.replace(/[^0-9]/g, '');
    if (valor && !input.value.startsWith('V-')) {
        input.value = 'V-' + valor;
    }
}

function formatearFecha(fecha) {
    const date = new Date(fecha + 'T00:00:00');
    return date.toLocaleDateString('es-ES', {
        year: 'numeric',
        month: 'long',
        day: 'numeric'
    });
}

function mostrarLoading(mostrar) {
    const overlay = document.getElementById('loading-overlay');
    overlay.style.display = mostrar ? 'flex' : 'none';
}

function mostrarNotificacion(mensaje, tipo = 'info') {
    const notification = document.createElement('div');
    notification.className = `notification ${tipo}`;
    notification.textContent = mensaje;

    document.body.appendChild(notification);

    setTimeout(() => {
        notification.style.animation = 'slideOutRight 0.3s ease-out forwards';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 300);
    }, 3000);
}

function mostrarFormularioEvento(evento = null) {
    eventoEditando = evento;
    if (evento) {
        document.getElementById('titulo-evento').value = evento.titulo;
        document.getElementById('fecha-evento').value = evento.fecha;
        document.getElementById('hora-evento').value = evento.hora;
        document.getElementById('descripcion-evento').value = evento.descripcion || '';
        document.getElementById('lugar-evento').value = evento.lugar || '';
    } else {
        document.getElementById('form-evento').reset();
    }
    document.getElementById('modal-evento').classList.add('active');
}

function mostrarFormularioResidente(residente = null) {
    residenteEditando = residente;
    if (residente) {
        document.getElementById('cedula-residente').value = residente.cedula;
        document.getElementById('nombre-residente').value = residente.nombre;
        document.getElementById('nacionalidad-residente').value = residente.nacionalidad;
        document.getElementById('estado-civil-residente').value = residente.estado_civil;
        document.getElementById('casa-residente').value = residente.casa;
        document.getElementById('tiempo-residencia').value = residente.tiempo_residencia;
    } else {
        document.getElementById('form-residente').reset();
    }
    document.getElementById('modal-residente').classList.add('active');
}

function mostrarFormularioEjecutivo(ejecutivo = null) {
    ejecutivoEditando = ejecutivo;
    if (ejecutivo) {
        document.getElementById('usuario-ejecutivo').value = ejecutivo.usuario;
        document.getElementById('nombre-ejecutivo').value = ejecutivo.nombre;
        document.getElementById('password-ejecutivo').value = ejecutivo.password;
        document.getElementById('rol-ejecutivo').value = ejecutivo.rol;
    } else {
        document.getElementById('form-ejecutivo').reset();
    }
    document.getElementById('modal-ejecutivo').classList.add('active');
}

function mostrarFormularioCenso() {
    document.getElementById('form-censo').reset();
    document.getElementById('campos-censo').innerHTML = `
        <div class="campo-censo">
            <input type="text" class="form-control campo-nombre" placeholder="Campo" style="flex: 1;">
            <input type="text" class="form-control campo-valor" placeholder="Valor" style="flex: 1;">
            <button type="button" class="btn-danger" onclick="eliminarCampoCenso(this)">üóëÔ∏è</button>
        </div>
    `;
    document.getElementById('modal-crear-censo').classList.add('active');
}

function agregarCampoCenso() {
    const camposDiv = document.getElementById('campos-censo');
    const nuevoCampo = document.createElement('div');
    nuevoCampo.className = 'campo-censo';
    nuevoCampo.innerHTML = `
        <input type="text" class="form-control campo-nombre" placeholder="Campo" style="flex: 1;">
        <input type="text" class="form-control campo-valor" placeholder="Valor" style="flex: 1;">
        <button type="button" class="btn-danger" onclick="eliminarCampoCenso(this)">üóëÔ∏è</button>
    `;
    camposDiv.appendChild(nuevoCampo);
}

function eliminarCampoCenso(button) {
    button.parentElement.remove();
}

function agregarFilaDatos() {
    const datosDiv = document.getElementById('datos-censo-edit');
    const nuevaFila = document.createElement('div');
    nuevaFila.className = 'dato-fila';
    nuevaFila.innerHTML = `
        <input type="text" placeholder="Campo" class="dato-campo">
        <input type="text" placeholder="Valor" class="dato-valor">
        <button type="button" class="btn-danger" onclick="eliminarFilaDatos(this)">üóëÔ∏è</button>
    `;
    datosDiv.appendChild(nuevaFila);
}

function eliminarFilaDatos(button) {
    button.parentElement.remove();
}

function cerrarModal(modalId) {
    document.getElementById(modalId).classList.remove('active');
}

async function actualizarGentilicio() {
    const nuevoGentilicio = document.getElementById('gentilicio-config').value.trim();
    if (nuevoGentilicio) {
        mostrarLoading(true);
        try {
            const { error } = await window.supabase
                .from('configuracion')
                .update({ gentilicio: nuevoGentilicio })
                .eq('id', configuracion.id);

            if (error) throw error;

            configuracion.gentilicio = nuevoGentilicio;
            mostrarNotificacion('Gentilicio actualizado correctamente', 'success');
        } catch (error) {
            console.error('Error al actualizar gentilicio:', error);
            mostrarNotificacion('Error al actualizar el gentilicio', 'error');
        }
        mostrarLoading(false);
    }
}

       // Funciones de importaciË¥∏n/exportaciË¥∏n
        function importarExcel(tipo) {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.xlsx,.xls,.csv';
            input.onchange = async function(e) {
                const file = e.target.files[0];
                if (file) {
                    mostrarLoading(true);
                    try {
                        if (tipo === 'residentes') {
                            mostrarNotificacion('Funcionalidad de importaciË¥∏n en desarrollo', 'info');
                        } else if (tipo === 'censo') {
                            // Simular creaciË¥∏n de censo desde archivo
                            const nuevoCenso = {
                                nombre: `Censo Importado - ${new Date().toLocaleDateString()}`,
                                tipo: 'importado',
                                fecha: new Date().toISOString().split('T')[0],
                                descripcion: 'Censo importado desde archivo Excel',
                                datos: [
                                    { categoria: 'Muestra 1', valor: '25', descripcion: 'Dato de ejemplo' },
                                    { categoria: 'Muestra 2', valor: '30', descripcion: 'Dato de ejemplo' },
                                    { categoria: 'Muestra 3', valor: '15', descripcion: 'Dato de ejemplo' }
                                ]
                            };
                            
                            const docRef = await window.addDoc(window.collection(window.db, 'censos'), nuevoCenso);
                            censos.push({ ...nuevoCenso, id: docRef.id });
                            await cargarCensos();
                            mostrarNotificacion('Censo importado exitosamente', 'success');
                        }
                    } catch (error) {
                        console.error('Error al importar archivo:', error);
                        mostrarNotificacion('Error al procesar el archivo', 'error');
                    }
                    mostrarLoading(false);
                }
            };
            input.click();
        }

        function exportarCenso() {
            mostrarNotificacion('Funcionalidad de exportaciË¥∏n en desarrollo', 'info');
        }

        function gestionarCensos() {
            showSection('censos');
            cerrarModal('modal-censo');
        }
    </script>
</body>
</html>
